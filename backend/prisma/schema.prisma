generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  member
  guest
}

enum ProjectLifecycle {
  active
  completed
  archived
  deleted
}

enum AiProvider {
  openai
  gemini
}

enum AuditActionType {
  auth_login
  auth_logout
  auth_refresh
  role_changed
  project_created
  project_updated
  project_deleted
  task_created
  task_updated
  task_deleted
  ai_request
  ai_response
  ai_denied
}

model Organization {
  id                 String   @id
  name               String
  plan               String   @default("basic")
  totalSeats         Int
  seatPrice          Int      @default(0)
  billingCurrency    String   @default("USD")
  ownerId            String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  aiDailyRequestLimit Int     @default(10)
  aiDailyTokenLimit  Int      @default(50000)
  deletedAt          DateTime?

  users              User[]
  projects           Project[]
  tasks              Task[]
  sessions           Session[]
  invites            Invite[]
  teams              Team[]
  groups             SecurityGroup[]
  auditLogs          AuditLog[]
  aiUsageDaily       AiUsageDaily[]
  aiInteractions     AiInteraction[]
}

model User {
  id             String   @id
  orgId          String
  username       String
  displayName    String
  firstName      String?
  lastName       String?
  email          String
  avatar         String?
  role           UserRole @default(member)
  passwordHash   String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sessions       Session[]

  @@unique([orgId, username])
  @@unique([orgId, email])
  @@index([orgId, role])
}

model Session {
  id               String   @id
  orgId            String
  userId           String
  refreshTokenHash String
  userAgent        String?
  ipAddress        String?
  isRevoked        Boolean  @default(false)
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId, userId, isRevoked])
  @@index([expiresAt])
}

model Project {
  id           String   @id
  orgId        String
  createdBy    String
  ownerId      String
  name         String
  description  String
  color        String
  memberIds    Json
  stageDefs    Json?
  lifecycle    ProjectLifecycle @default(active)
  isPublic     Boolean  @default(false)
  publicToken  String?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([orgId, lifecycle])
  @@index([orgId, ownerId])
  @@unique([orgId, publicToken])
}

model Task {
  id             String   @id
  orgId          String
  projectId      String
  createdBy      String
  title          String
  description    String
  status         String
  priority       String
  assigneeIds    Json?
  securityGroupIds Json?
  tags           Json
  blockedByIds   Json?
  blocksIds      Json?
  subtasks       Json
  comments       Json
  auditLog       Json
  metadata       Json?
  dueDate        DateTime?
  completedAt    DateTime?
  orderIndex     Int      @default(0)
  timeLoggedMs   Int      @default(0)
  timerStartedAt DateTime?
  isTimerRunning Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([orgId, projectId, status])
  @@index([orgId, dueDate])
  @@index([orgId, updatedAt])
}

model Team {
  id           String   @id
  orgId        String
  name         String
  description  String?
  leadId       String?
  memberIds    Json
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, name])
}

model SecurityGroup {
  id           String   @id
  orgId        String
  name         String
  scope        String
  projectId    String?
  memberIds    Json
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, scope, projectId])
}

model Invite {
  id               String   @id
  orgId            String
  token            String
  role             UserRole @default(member)
  createdBy        String
  createdAt        DateTime @default(now())
  expiresAt        DateTime
  maxUses          Int      @default(1)
  usedCount        Int      @default(0)
  revoked          Boolean  @default(false)
  invitedIdentifier String?

  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, token])
  @@index([orgId, expiresAt])
}

model AiUsageDaily {
  id                 String   @id
  orgId              String
  dayKey             String
  requestsUsed       Int      @default(0)
  tokensUsed         Int      @default(0)
  warningIssuedAt    DateTime?
  blockedAt          DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  organization       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, dayKey])
  @@index([orgId, dayKey])
}

model AiInteraction {
  id                 String   @id
  orgId              String
  userId             String
  provider           AiProvider
  feature            String
  model              String
  prompt             String
  response           String
  inputTokens        Int      @default(0)
  outputTokens       Int      @default(0)
  totalTokens        Int      @default(0)
  wasFallback        Boolean  @default(false)
  createdAt          DateTime @default(now())

  organization       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([orgId, userId, createdAt])
}

model AuditLog {
  id                 String   @id
  orgId              String
  userId             String?
  actionType         AuditActionType
  action             String
  entityType         String?
  entityId           String?
  metadata           Json?
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime @default(now())

  organization       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([orgId, actionType, createdAt])
}
