apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        # ---------------------------------------------------
        # 1. YOUR BACKEND APP CONTAINER
        # ---------------------------------------------------
        - name: backend
          # REPLACE with your actual image path from Cloud Build
          image: gcr.io/$PROJECT_ID/backend-image:latest
          ports:
            - containerPort: 3000 # Match your backend port
          env:
            - name: DATABASE_URL
              # Connect to 127.0.0.1 because the proxy is running right next to it!
              value: "postgresql://postgres:YOUR_DB_PASSWORD@127.0.0.1:5432/my_app_db"
            - name: PORT
              value: "3000"

        # ---------------------------------------------------
        # 2. THE CLOUD SQL PROXY (SIDECAR)
        # ---------------------------------------------------
        - name: cloud-sql-proxy
          image: gcr.io/cloudsql-docker/gce-proxy:1.33.2
          command:
            - "/cloud_sql_proxy"
            # REPLACE with your Connection Name (Project:Region:Instance)
            - "-instances=$PROJECT_ID:us-central1:my-postgres-db=tcp:5432"
          securityContext:
            runAsNonRoot: true